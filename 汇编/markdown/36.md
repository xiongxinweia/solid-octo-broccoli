+ [author](https://github.com/3293172751)

# 第36节 端口的读写

+ [回到目录](../README.md)
+ [回到项目首页](../../README.md)
+ [上一节](35.md)
> ❤️💕💕汇编语言目前仍在发挥着不可替代的作用，在效率上无可替代，在底层，学习linux内核，计算机外围设备和驱动，都离不开汇编。Myblog:[http://nsddd.top](http://nsddd.top/)
---
[TOC]

## 端口

在PC机中，和CPU通过总线相连的芯片除了各种存储器外，还有以下3中芯片：

1. 各种接口卡（例如网卡、显卡）上的接口芯片，它们控制接口卡工作
2. 主板上的接口芯片，CPU通过它们对部分外设进行访问
3. 其它芯片，用来存储相关的系统信息，或处理相关的输入输出

这些芯片中都有一组可以由CPU读写的寄存器，这些寄存器在物理上可能处于不同的芯片中，它们在以下两点上相同：

1. 通过它们所在的芯片，和CPU的总线相连
2. CPU对它们读写的时候，都通过控制线向它们所在的芯片发出端口读写指令

从CPU角度，将这些寄存器都当做端口，对它们进行统一编址，从而建立一个统一的端口地址空间，每一个端口在地址空间中都有一个地址。



**CPU可以直接读写以下3个地方的数据：**

1. CPU内部的寄存器

2. 内存单元

3. 端口

   1. 对应各种接口、网卡、显卡
   2. 主板上的接口芯片
   3. 其他芯片

   

## 端口的读写

在访问端口的时候，CPU通过端口地址来定位端口。端口所在的芯片和CPU通过总线相连，因此端口地址和内存地址一样，通过地址总线来传送。

在PC系统中，CPU最多可以定位64KB个不同的端口，则端口地址的范围为`0~65535`

端口的读写指令只有以下两条：



### IN指令（端口输入指令）

**格式：**

```
IN container , port
```

**用途：**

从端口 `port` 处读入一个字节至 `container` 处。

> **CPU 从端口读取数据**



### OUT指令（端口输出指令）

**格式：**

```
OUT port , container
```

**用途：**

从 `container` 处写入一个字节至端口 `port` 处。

> **CPU 往端口写入数据**



访问端口时，与总线的相关操作如下：

1. CPU通过地址线将端口地址信息发出
2. CPU通过控制线发出端口读命令，选中端口所在的芯片，并通知它将要从中读取数据
3. 端口所在的芯片将对应端口中的数据通过数据线送入CPU

在 IN 和 OUT 指令中，只能使用 AX 或 AL 来存放从端口中读取的数据或要发送到端口中的数据：访问8位端口时用 AL ，访问16位端口时用 AX 。



## 端口的读写

在访问端口的时候，CPU通过端口地址来定位端口。因为端口所在的芯片和CPU通过总线相连，所以，**端口地址和内存地址一样，通过地址总线来传送**。在PC系统中，CPU最多可以定位`64KB`个不同的端口。则端口地址的范围为`0~65535`
对端口的读写不能用`mov`, `push`, `pop`等内存读写指令。端口的读写指令只有两条:`in`和`out`，分别用于从端口读取数据和往端口写入数据。

### 访问内存

```
mov ax,ds:[8]    ;假设执行前(ds)=0
```

执行时与总线相关的操作如下所示。
①CPU通过地址线将地址信息8发出;
②CPU通过控制线发出内存读命令，选中存储器芯片，并通知它，将要从中读取数据;
③存储器将8号单元中的数据通过数据线送入CPU



### 访问端口

```
in al，60h  ;从60h号端口读入一个字节
```

**执行时与总线相关的操作如下:**

①CPU通过地址线将地址信息`60h`发出

②CPU通过控制线发出端口读命令，选中端口所在的芯片，并通知它，将要从中读取数据

③端口所在的芯片将60h端口中的数据通过数据线送入CPU

> 注意，在`in`和`out`指令中，**只能使用`ax`或`al`来存放从端口中读入的数据或要发送到端口中的数据**。访问`8`位端口时用`al`，访问`16`位端口时用`ax`



对0~255以内的端口进行读写时,端口号要用立即数给出：

```assembly
in al，20h;从20h端口读入一个字节
out 20h，al;往20h端口写入一个字节
```



对256~65535的端口进行读写时，端口号(16位）放在dx中:

```assembly
mov dx，3f8h    ;将端口号3f8h送入dx
in   a1，dx     ;从3f8h端}l读入一个字节 
out  dx,al，    ;向3f8h端口写入一个字节
```

### 案例

任务：访问61端口发声

```assembly
assume cs:codeseg
codeseg segment
start: mov al, 08h        ;设置声音的频率
          out 42h, al       
          out 42h, al  
          in al, 61h           ;读设备控制器端口原值
          mov ah, al         ;保存原值     
          or al, 3               ;打开扬声器和定时器
          out 61h, al        ;接通扬声器，发声
          mov cx, 60000  ;延时
delay:
         nop
         loop delay
         mov al, ah         ;恢复端口原值
         out 61h, al
        mov ax, 4c00h
        int 21h
codeseg ends
```



## CMOS RAM芯片

PC机中，有一个CMOS  RAM[^RAM]

芯片（一般简称为CMOS），此芯片的特征如下：

- 包含一个实时钟和一个有`128`个存储单元的`RAM`存储器。
- 该芯片靠电池，所以关机后其内部的实时钟仍可以正常工作，RAM的信息不会丢失。
- 128个字节的RAM中，内部实时钟占用`0~0DH`单元来保存时间信息，其余大部分单元用于保存系统配置信息，供系统启动时相关系统读取。相关系统也提供了程序，使我们可以在开机时配置CMOS RAM中的系统信息。
- 该芯片内部有两个端口，端口地址为`70H`和`71H`。**CPU通过这两个端口来读写CMOS RAM。**
  - `70H`为地址端口，存放要访问的CMOS RAM单元的地址；
  - `71H`为数据端口，存放从选定的CMOS RAM单元中读取的数据，或要写入到其中的数据。

> CPU对CMOS RAM的读写分两步进行：先将地址送入端口70H，再从端口71H读写数据。



## CMOS RAM存储的时间信息

> > **在屏幕中间显示当前的月份**

CMOS RAM中存放着当前的时间：年、月、日、时、分、秒，**这6个信息的长度都为1个字节**，存放单元为：

|          |      |      |      |      |      |      |      |      |      |      |
| -------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| **内容** | 秒   |      | 分   |      | 时   |      |      | 日   | 月   | 年   |
| **地址** | 00   | 01   | 02   | 03   | 04   | 05   | 06   | 07   | 08   | 09   |

这些数据以BCD码的形式存放。

BCD码是以4位二进制数表示的十进制数码的编码方式，如下所示：

![img](assets/BCD-codec.png)

一个字节可以表示两个BCD码，即CMOS RAM存储时间信息的单元中，存储了两个用BCD码表示的两位十进制数，高4位的BCD码表示十位，低4位的BCD码表示个位。



**以下程序段在屏幕中间显示当前的月份：**

从CMOS RAM的8号单元读出当前月份的BCD码。过程分两步：

1. 首先向地址端口70H写入单元地址8
2. 从数据端口71H中取得指定单元的数据：

```assembly
mov al, 8

out 70h, al ; write address info to 70h port

in al, 71h  ; get data from 71h port
```

将从CMOS RAM的8号单元中读出的第一个字节，分为两个表示BCD码值的数据。以上程序段使用移位和掩码分别取得高4位和低4位：

```assembly
mov ah, al     ; (AL) is the data from CMOS RAM [8]
mov cl, 4
shr ah, cl     ; (AH) is the tens of month
and al, 00001111B ; (AL) is the ones of month
```

最后，在屏幕上中间位置显示对应的字符。将数据加上30H是为了将数字转化为对应的字符：

```assembly
add ah, 30h		;转化为对应的ASCII
add al, 30h
mov bx, 0b800h
mov es, bx
mov byte ptr es: [2000], ah ; show the tens of month
mov byte ptr es: [2002], al ; show the ones of month
```



## END 链接

[^RAM]: RAM（发音同 ram），是指随机存取存储器（random access memory，RAM）又称作“随机存储器”，是与CPU直接交换数据的内部存储器，也叫主存(内存)。它可以随时读写，而且速度很快，通常作为操作系统或其他正在运行中的程序的短时间临时数据存储媒介。计算机首先从存储盘将用户请求的程序或文档加载到内存，然后从内存中访问每条信息。由于许多操作均依赖于内存，因此RAM 容量在系统性能方面起着至关重要的作用。这个RAM不一样的地方在于：一般的RAM关机后信息丢失，而**CMOS RAM 芯片靠电池供电，**关机后其内部的实时钟仍然可以工作，RAM信息不丢失。

+ [回到目录](../README.md)
+ [上一节](35.md)
+ [下一节](37.md)
---
+ [参与贡献❤️💕💕](https://github.com/3293172751/Block_Chain/blob/master/Git/git-contributor.md)